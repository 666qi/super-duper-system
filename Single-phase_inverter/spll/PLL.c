/*
 * PLL.c
 *
 *  Created on: 2025年10月24日
 *      Author: LW
 */

// --------------------------------------
// 头文件
// --------------------------------------

#include "F28x_Project.h"


// --------------------------------------
// 变量定义
// --------------------------------------

//d-q 变量
str_d_qDef              str_d_q = {0};


// --------------------------------------
// 变量声明
// --------------------------------------

//SOGI_PLL 变量
str_SOGI_PLLDef        str_SOGI_PLL;


// --------------------------------------
// 函数定义
// --------------------------------------

// =============================================================================
/*******************************************************************************
 函数名称：   void Init_SOGI_PLL(float32_t kp, float32_t ki, float32_t init_err,
                              float32_t init_last_err, float32_t freq)
 功能描述：   初始化SOGI-PLL（二阶广义积分器锁相环）算法参数
 输入参数：   kp            - 比例系数，控制频率跟踪响应速度
           ki            - 积分系数，消除稳态相位误差
           init_err      - 初始相位误差值
           init_last_err - 初始上一周期相位误差值
           freq          - 初始频率值(Hz)，内部转换为角频率(rad/s)
 输出参数：   无
 返 回 值：  无
 其它说明：   a. 允许外部灵活配置PLL参数，适应不同应用场景
           b. 内部自动将频率freq(Hz)转换为角频率w_internal(rad/s)：w=2πf
 修改日期        版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/11/11    V1.0           LW              创建
********************************************************************************/
/* ------------------------------------------------------------
参数说明：
 1. kp：比例系数，值越大响应越快但可能超调
 2. ki：积分系数，影响稳态精度和收敛速度
 3. init_err/init_last_err：初始化误差状态，通常设为0
 4. freq：初始频率(Hz)，内部自动转换为角频率(rad/s)
 *
 * ------------------------------------------------------------ */
void Init_SOGI_PLL(float32_t kp, float32_t ki,float32_t freq, float32_t init_err,
                   float32_t init_last_err)
{
    str_SOGI_PLL.wkp = kp;                  // 设置锁相环比例系数，控制频率跟踪的动态响应速度
    str_SOGI_PLL.wki = ki;                  // 设置锁相环积分系数，用于消除稳态相位误差
    str_SOGI_PLL.w_internal = PI2*freq;     // 将输入频率(Hz)转换为角频率(rad/s)：ω = 2πf
    str_SOGI_PLL.err = init_err;            // 初始化当前周期的相位误差值，通常设置为0
    str_SOGI_PLL.err_last = init_last_err;  // 初始化上一周期的相位误差值，通常设置为0

}

// =============================================================================
/*******************************************************************************
 函数名称：   void SOGI_PLL(void)
 功能描述：   实现基于SOGI的软件锁相环(PLL)算法，用于电网同步
 输入参数：   无
 输出参数：   无
 返 回 值：   无
 其它说明：   a. SOGI生成正交信号 → Park变换得到dq分量 → PI控制频率 → 积分得到相位
             b. 采用频率自适应机制，实现电网频率变化时的准确跟踪
             Vin → SOGI → Uα,Uβ → Park变换 → Uq → PI控制器 → ω → 积分器 → θ
 修改日期      版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/10/10    V1.0           LW              创建
********************************************************************************/
/* ------------------------------------------------------------
控制流程：
 1. SOGI二阶广义积分器：生成电网电压的正交分量(Uα, Uβ)
 2. 坐标变换：将αβ坐标系转换到旋转dq坐标系
 3. 频率调节：以Uq作为相位误差，通过PI控制器调节角频率
 4. 相位生成：对角频率积分得到同步相位角
 *
 * ------------------------------------------------------------ */
void SOGI_PLL(void)
{

    // 1.相位误差计算：q轴分量为相位误差信号
    str_SOGI_PLL.err = 0 -str_d_q.wVq;

    // 2. PI调节：计算频率修正量
    str_SOGI_PLL.pi_out =  str_SOGI_PLL.wkp * (str_SOGI_PLL.err - str_SOGI_PLL.err_last)+str_SOGI_PLL.wki * str_SOGI_PLL.err*Ts;

    // 3. 频率更新与限幅（45-55Hz保护）
    str_SOGI_PLL.w_internal = str_SOGI_PLL.w_internal - str_SOGI_PLL.pi_out;

    if(str_SOGI_PLL.w_internal >= 110*PI) str_SOGI_PLL.w_internal = 110*PI;     // 上限55Hz
    if(str_SOGI_PLL.w_internal <= 90*PI)  str_SOGI_PLL.w_internal = 90*PI;      // 下限45Hz

    str_SOGI_PLL.err_last =str_SOGI_PLL. err;                 // 保存误差

    g_Omega= str_SOGI_PLL.w_internal;                        // 输出角频率

    // 4. 相位积分
    g_Theta= g_Theta + g_Omega* Ts;

    // 5. 相位限制（0-2π）
   if(g_Theta > PI2 )        g_Theta -=PI2;
   if(g_Theta < 0.0f )       g_Theta +=PI2;

}


// =============================================================================
/*******************************************************************************
 函数名称：   void Delay_PLL(void)
 功能描述：   基于延时法的锁相环核心算法，更新相位和频率
 输入参数：   无
 输出参数：   无
 返 回 值：  无
 其它说明：   a. 采用增量式PID控制器调节角频率
           b. 通过积分运算实现相位跟踪
           c. 相位范围限制在[0, 2π]区间，防止溢出
 算法原理：
     1. 使用Q轴电压误差通过PI控制器生成角频率修正量
     2. 对角频率积分得到相位角度：θ = ∫ω dt
     3. 相位循环控制，确保在0-2π范围内连续变化
 控制逻辑：
     ω = PI(Vq_error)   // PI控制器输出角频率
     θ += ω × Ts        // 积分得到相位
     θ = mod(θ, 2π)     // 相位归一化
 修改日期         版本号          修改人            修改内容
 -----------------------------------------------------------------------------
 2025/10/30    V1.0           LW              创建
********************************************************************************/
void Delay_PLL(void)
{
    // --------------------------------------------
    // 1、角频率更新 - 通过PI控制器调节
    // --------------------------------------------
    // 使用Q轴电压误差计算角频率修正量
    // Incremental_PID: 增量式PID算法，避免积分饱和
    g_Omega = Incremental_PID(str_d_q.wVq, &PLL_PI);            //延时法获得角频率

    // --------------------------------------------
    // 2、相位积分 - 角频率对时间积分得到相位
    // --------------------------------------------
    // 数值积分：Δθ = ω × Δt
    // Ts: 采样周期（如20kHz对应50us）
    g_Theta += g_Omega * Ts;                   // 角频率 * 时间 = 弧长

    // --------------------------------------------
   // 3、相位归一化 - 确保相位在[0, 2π)范围内
   // --------------------------------------------
   // 相位正向溢出处理：超过2π时减去2π
    if (g_Theta > PI2)     g_Theta -= PI2;

   // 相位负向溢出处理：小于0时加上2π
    if (g_Theta < 0.0f)    g_Theta += PI2;
}




// ---------------------------------
// End of File
// ---------------------------------
